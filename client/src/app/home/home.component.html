<app-top-bar></app-top-bar>

<main class="py-md-4 px-md-2">
    <div class="container-fluid">
        <div class="d-flex column-gap-2 flex-wrap">
            <section class="row column-gap-2 main">
                <div class="col zone p-2 shadow-sm">
                    <h5 class="fs-6 fw-lighter mx-2 my-3">TODO</h5>
                    <ng-container *ngTemplateOutlet="listBoardTemplate; 
                        context: {list: shoppingList, type:ListType.ShoppingList}">
                    </ng-container>

                </div>

                <div class="col zone p-2 shadow-sm">
                    <h5 class="fs-6 fw-lighter mx-2 my-3">IN PROGRESS</h5>
                    <ng-container *ngTemplateOutlet="listBoardTemplate; 
                        context: {list: buyingList, type:ListType.BuyingList}">
                    </ng-container>
                </div>

                <div class="col zone p-2 shadow-sm">
                    <h5 class="fs-6 fw-lighter mx-2 my-3">DONE
                        <span *ngIf="doneList.length"> {{doneList.length}} OF {{mergedList.length}}</span>
                    </h5>
                    <ng-container *ngTemplateOutlet="listBoardTemplate; 
                        context: {list: doneList, type:ListType.DoneList}">
                    </ng-container>
                </div>

                <app-log-list style="flex:2" class="d-flex justify-content-end"></app-log-list>

            </section>

            <app-user-list></app-user-list>

        </div>
    </div>
</main>

<ng-template #listBoardTemplate let-list="list" let-type="type">
    <div class="dndList" dndEffectAllowed="move" dndDropzone [dndHorizontal]="layout.dndHorizontal"
        [class.horizontal]="layout.dndHorizontal" (dndDrop)="onDrop($event, type, list)">

        <div class="placeholder" dndPlaceholderRef>
        </div>

        <ng-container *ngFor="let item of list">
            <div class="card my-1 item-card" [dndDraggable]="{ item: item, origin: type}" [dndDisableDragIf]="(editMode && toEditItem.id == item.id) || !item.assignedUser ||
                (item.assignedUser &&  item.assignedUser.id != getLogInId())" dndEffectAllowed="move"
                (dndMoved)="onDragged(item, list, 'move')">
                <div class="card-body relative">

                    @if(type != ListType.DoneList){
                    @if(!editMode || (editMode && toEditItem.id != item.id))
                    {
                    <div class="d-flex justify-content-between align-items-center">
                        @if((!item.assignedUser && type == ListType.ShoppingList) ||
                        (getLogInId() == item.assignedUser?.id)){
                        <div>
                            <span class="edit" (click)="toggleEdit(item)"> {{item.name}}</span>
                            <button class="btn edit btn-sm btn-outline-light border-0" (click)="toggleEdit(item)">
                                ‚úíÔ∏è
                            </button>
                        </div>
                        <button class="btn btn-sm bg-transparent border-0 p-0"
                            (click)="onDeleteItem(item, type)">‚ùå</button>
                        }
                        @else{ <span> {{item.name}}</span>}
                    </div>
                    }

                    @if(editMode && toEditItem.id == item.id){
                    <input #editItemInput [(ngModel)]="toEditItem.name" class="form-control transparent-input border"
                        placeholder="Edit shopping item" />
                    <button class="btn btn-sm btn-outline-light" (click)="onEdit(type, item)">
                        ‚úîÔ∏è
                    </button>

                    <button class="btn btn-sm btn-outline-light" (click)="onResetEdit()">
                        ‚ùå
                    </button>
                    }
                    }
                    @else{
                    <span> {{item.name}} @if(type == ListType.DoneList){‚úÖ }</span>
                    }

                    <div class="d-flex align-items-center justify-content-between relative mt-4">
                        <div class="relative">
                            <a (click)="$event.stopPropagation(); toggleUserDropdown(item.id, type)"
                                class="btn p-0 text-decoration-none align-items-center d-flex align-items-center">
                                <div class="avatar-sm rounded-circle d-flex justify-content-center align-items-center bg-dark text-white"
                                    [ngStyle]="{'border-color': item.assignedUser?.color ?? 'white'}">
                                    <span class="text-8">
                                        {{(item.assignedUser?.initials | uppercase) ?? 'üê∂' }}
                                    </span>
                                </div>
                                <span class="ms-2 text-sm" [class]="{'text-secondary':!item.assignedUser}"
                                    [style.color]="item.assignedUser?.color">
                                    {{item.assignedUser?.username.split('@')[0] ?? 'Unassigned' }}
                                </span>
                            </a>
                            <ul #usersDropdown *ngIf="assignMode && selectedTaskId == item.id"
                                class="assign-users user-dropdown position-absolute bg-dark text-white p-1 rounded shadow-sm">
                                <h6 class="ms-3 mt-3 text-sm">Assign</h6>
                                @if(type == ListType.ShoppingList)
                                {
                                <a (click)="onAssignUser(item, null, type)"
                                    class="unassigned btn text-decoration-none align-items-center d-flex align-items-center">
                                    <div class="avatar-sm rounded-circle bordered d-flex justify-content-center 
                                                    align-items-center bg-dark text-white">
                                        <span class="text-8"> üê∂ </span>
                                    </div>
                                    <span class="ms-2 text-sm">Unassigned</span>
                                </a>
                                }
                                <li *ngFor="let user of allUsers" class="dropdown-item text-white rounded-md">
                                    <a class="d-flex btn text-decoration-none align-items-center"
                                        (click)="onAssignUser(item,user, type)">
                                        <div class="avatar-sm rounded-circle d-flex justify-content-center align-items-center bg-dark text-white"
                                            [ngStyle]="{'border-color': user.color}">
                                            <span class="text-8"> {{ user.initials | uppercase }}</span>
                                        </div>
                                        <span class="ms-2 text-sm"
                                            [style.color]="user.color">{{user.username.split('@')[0]}}</span>
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <div class="fw-lighter text-end text-xs align-self-end">
                            {{item.createdAt | date:'short'}}
                        </div>
                    </div>
                </div>

            </div>

        </ng-container>

        @if(type == ListType.ShoppingList){
        @if(!createItemToggle){
        <button class="btn create py-3 w-100 text-start" [ngClass]="{'border border-1': createItemToggle}"
            (click)="toggleCreate()"> +
            Add Item
        </button>
        }

        @else {
        <div #cardElement class="card my-1 border">
            <div class="card-body d-flex flex-column p-2">
                <input #shoppingItemInput [(ngModel)]="shoppingItem" placeholder="Enter shopping item"
                    class="form-control transparent-input mb-3" />
                <div class="align-self-end">
                    <button (click)="addItem()" class="btn btn-sm btn-primary text-end"
                        [disabled]="shoppingItem == ''">Create</button>
                </div>
            </div>
        </div>
        }
        }
    </div>
</ng-template>